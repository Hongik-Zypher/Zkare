# Zkare 의료 기록 관리 시스템

## 프로젝트 소개

Zkare는 이더리움 스마트 컨트랙트 기반의 간단하고 안전한 의료 기록 관리 시스템입니다.

- **스마트컨트랙트**: 환자 의료 기록의 안전한 저장/조회/검증
- **프론트엔드**: React 기반 UI, MetaMask 연동
- **개발환경**: Hardhat(로컬 이더리움), Cursor(코드 AI), GitHub 협업

## 주요 특징

### 기본 기능
- ✅ **완전한 탈중앙화**: 백엔드 서버 없이 프론트엔드에서 스마트 컨트랙트와 직접 통신
- ✅ **권한 기반 접근제어**: 의사만 의료 기록 추가 가능
- ✅ **디지털 서명**: ECDSA 서명으로 의료 기록 무결성 보장
- ✅ **투명성**: 모든 거래가 블록체인에 투명하게 기록
- ✅ **간단한 구조**: 복잡한 영지식증명 없이 기본적인 의료 기록 관리에 집중

### 🔐 새로운 암호화 기능 (v2.0)
- ✅ **RSA 비대칭키 암호화**: 의사와 환자의 개별 키 쌍 생성 및 관리
- ✅ **이중 암호화 시스템**: AES 대칭키로 데이터 암호화 + RSA 공개키로 대칭키 암호화
- ✅ **환자 기본정보 암호화**: 이름, 키, 몸무게, 혈액형, 주민번호 등 민감 정보 보호
- ✅ **진료기록 암호화**: 증상, 진단, 치료, 처방 등 모든 의료 데이터 암호화
- ✅ **선택적 복호화**: 의사와 환자가 각자의 개인키로만 데이터 복호화 가능
- ✅ **공개키 등록 시스템**: 블록체인에 공개키 등록 및 검증

---

## 개발 환경 세팅

### 1. 의존성 설치

```bash
npm install
cd frontend && npm install
```

### 2. 환경 변수 설정

프로젝트 루트에 `.env` 파일을 생성하고 아래 예시처럼 작성하세요:

```
PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
CONTRACT_ADDRESS=배포된_컨트랙트_주소_여기에_입력
RPC_URL=http://127.0.0.1:8545
```

- `PRIVATE_KEY`는 하드햇 기본 첫 번째 계정의 프라이빗키입니다.
- `CONTRACT_ADDRESS`는 배포 후 출력되는 MedicalRecord 컨트랙트 주소를 입력하세요.

### 3. 하드햇 노드 실행 (로컬 이더리움)

```bash
npx hardhat node
```

### 4-A. 기본 시스템 배포

```bash
npx hardhat run scripts/deploy.js --network localhost
```

- 배포가 완료되면, 콘솔에 MedicalRecord 컨트랙트 주소가 출력됩니다.
- 이 주소를 `.env`와 `frontend/src/utils/contracts.js`의 `MEDICAL_RECORD_ADDRESS`에 입력하세요.

### 4-B. 🔐 암호화된 의료기록 시스템 배포

```bash
npx hardhat run scripts/deploy-encrypted.js --network localhost
```

- KeyRegistry와 EncryptedMedicalRecord 컨트랙트가 배포됩니다.
- 배포 완료 후 출력되는 주소들을 `.env` 파일에 추가하세요:
```bash
REACT_APP_KEY_REGISTRY_ADDRESS=0x...
REACT_APP_ENCRYPTED_MEDICAL_RECORD_ADDRESS=0x...
```

### 5. 프론트엔드 실행

```bash
cd frontend
npm start
```

- 브라우저에서 `http://localhost:3000` 접속
- MetaMask에서 하드햇 네트워크(`http://127.0.0.1:8545`) 추가 및 첫 번째 계정 import

---

## 시스템 구조

```
Zkare/
├── contracts/           # 스마트컨트랙트 (Solidity)
│   ├── MedicalRecord.sol          # 기본 의료기록 컨트랙트
│   ├── AccessControl.sol          # 접근제어 컨트랙트
│   ├── KeyRegistry.sol            # 🔐 공개키 등록 관리 컨트랙트
│   └── EncryptedMedicalRecord.sol # 🔐 암호화된 의료기록 컨트랙트
├── scripts/             # 배포/자동화 스크립트
│   ├── deploy.js                  # 기본 컨트랙트 배포
│   └── deploy-encrypted.js        # 🔐 암호화 컨트랙트 배포
├── frontend/            # React 프론트엔드
│   ├── src/
│   │   ├── components/      # React 컴포넌트
│   │   │   ├── KeyGeneration.js       # 🔐 키 생성 컴포넌트
│   │   │   ├── PatientLookup.js       # 🔐 환자 조회 컴포넌트
│   │   │   ├── MedicalRecordViewer.js # 🔐 기록 조회 컴포넌트
│   │   │   └── EncryptedMedical.css   # 🔐 암호화 기능 스타일
│   │   ├── pages/          # 페이지 컴포넌트
│   │   │   ├── Home.js              # 기본 홈페이지
│   │   │   └── EncryptedMedical.js  # 🔐 암호화 의료기록 페이지
│   │   ├── utils/          # 유틸리티 (컨트랙트 연동)
│   │   │   ├── contracts.js         # 기본 컨트랙트 연동
│   │   │   └── encryption.js        # 🔐 암호화/복호화 유틸리티
│   │   └── abis/           # 컨트랙트 ABI 파일
├── artifacts/           # 하드햇 컴파일 결과
├── .env                 # 환경변수 파일 (직접 생성)
└── README.md            # 이 문서
```

---

## 사용 방법

### 기본 기능 (/)
#### 1. 지갑 연결
- 웹사이트 접속 후 "MetaMask 연결" 버튼 클릭
- MetaMask에서 계정 연결 승인

#### 2. 의사 권한 획득
- 컨트랙트 Owner(배포자)가 의사 주소를 등록해야 함
- Owner 계정으로 로그인 시 "의사 관리" 메뉴에서 의사 추가 가능

#### 3. 의료 기록 관리
- **의사 계정**: 
  - 환자 주소 입력 후 "의료 기록 추가" 버튼으로 새 기록 추가
  - 진단, 처방, 날짜, 메모 등 입력 가능
- **모든 사용자**:
  - 환자 주소 입력 후 "조회" 버튼으로 해당 환자의 모든 의료 기록 조회

---

### 🔐 암호화된 의료기록 시스템 (/encrypted)

#### 1. 키 생성 및 등록
- **RSA 키 쌍 생성**: "키 생성" 버튼을 클릭하여 2048비트 RSA 키 쌍 생성
- **사용자 유형 선택**: 환자 또는 의사 중 선택
- **공개키 등록**: 생성된 공개키를 블록체인에 등록
- **개인키 다운로드**: 생성된 개인키를 안전한 곳에 저장 (⚠️ 분실 시 복구 불가능)

#### 2. 환자 조회 및 진료기록 작성 (의사만 가능)
- **환자 주소 입력**: 진료할 환자의 지갑 주소 입력
- **환자 상태 확인**:
  - ❌ 공개키 미등록: "등록되지 않았습니다" 안내
  - 👤 신규 환자: 기본정보 + 진료기록 작성
  - 📋 기존 환자: 진료기록만 추가
- **기본정보 입력** (신규 환자):
  - 이름, 키, 몸무게, 혈액형, 주민번호
- **진료기록 입력**:
  - 증상, 진단, 치료, 처방, 메모
- **암호화 저장**: 모든 데이터가 AES+RSA 이중암호화되어 저장

#### 3. 진료기록 조회
- **개인키 업로드**: 다운로드받은 개인키 파일 업로드
- **기록 로드**:
  - 환자: "내 진료기록 로드" 버튼 클릭
  - 의사: 환자 주소 입력 후 "환자 기록 로드" 버튼 클릭
- **복호화**: "모든 기록 복호화" 또는 개별 "이 기록 복호화" 버튼 클릭
- **조회**: 복호화된 기본정보 및 모든 진료기록 확인

#### 4. 보안 특징
- **이중 암호화**: 
  1. 의료 데이터를 AES-256-GCM으로 암호화
  2. AES 키를 의사/환자 공개키로 각각 RSA 암호화
- **선택적 접근**: 의사와 환자만 각자의 개인키로 복호화 가능
- **무결성 보장**: 블록체인에 암호화된 데이터와 메타데이터 저장
- **개인정보 보호**: 주민번호는 마스킹 처리하여 표시

---

## 스마트 컨트랙트 주요 기능

### MedicalRecord.sol
- `addDoctor(address)`: 의사 추가 (Owner만 가능)
- `removeDoctor(address)`: 의사 제거 (Owner만 가능)
- `isDoctor(address)`: 의사 여부 확인
- `addMedicalRecord(...)`: 의료 기록 추가 (의사만 가능)
- `getMedicalRecord(...)`: 의료 기록 조회
- `getRecordCount(address)`: 환자의 기록 수 조회

---

## 트러블슈팅

### 일반적인 문제
- **컨트랙트 주소 오류**: `.env` 파일과 `contracts.js`의 주소가 일치하는지 확인
- **MetaMask 네트워크**: 하드햇 로컬 네트워크(`http://127.0.0.1:8545`)에 연결되어 있는지 확인
- **의사 권한 없음**: Owner 계정으로 해당 주소를 의사로 등록했는지 확인
- **Gas 부족**: MetaMask에서 충분한 ETH가 있는지 확인

### 개발자 도구 활용
- 브라우저 개발자 도구 콘솔에서 에러 메시지 확인
- MetaMask 활동 탭에서 트랜잭션 상태 확인
- Hardhat 노드 터미널에서 블록체인 로그 확인

---

## 향후 개발 계획

### 단기 계획
- [ ] 환자별 의료 기록 검색 기능
- [ ] 의료 기록 수정/삭제 기능 (권한 제어)
- [ ] 의료진 정보 관리 시스템
- [ ] 기록 카테고리 분류 (진료과별)

### 중기 계획
- [ ] IPFS 연동으로 대용량 의료 데이터 저장
- [ ] 환자 동의 시스템 구현
- [ ] 모바일 앱 개발 (React Native)
- [ ] 다중 병원 네트워크 지원

### 장기 계획
- [ ] Layer 2 네트워크 이전 (가스비 절약)
- [ ] 의료 표준 프로토콜 준수 (HL7 FHIR)
- [ ] 보험사 연동 시스템
- [ ] AI 기반 의료 기록 분석

---

## 기여하기

1. 이 저장소를 Fork 하세요
2. 새로운 기능 브랜치를 만드세요 (`git checkout -b feature/새기능`)
3. 변경사항을 커밋하세요 (`git commit -am '새기능 추가'`)
4. 브랜치에 Push 하세요 (`git push origin feature/새기능`)
5. Pull Request를 만드세요

---

## 라이센스

이 프로젝트는 MIT 라이센스 하에 배포됩니다.

## 팀원 협업 안내

- **GitHub**에서 브랜치 전략을 지키고, 커밋 메시지는 명확하게 작성하세요.
- **Cursor**를 적극 활용해 코드 리뷰, 문서화, 버그 수정, 질문 등을 빠르게 해결하세요.
- 궁금한 점은 README에 추가하거나, Cursor에게 바로 물어보세요!
